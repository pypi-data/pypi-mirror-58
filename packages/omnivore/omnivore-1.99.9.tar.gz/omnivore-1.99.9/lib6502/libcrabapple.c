#include "libcrabapple.h"
#include "6502.h"

/* Apple ][ graphics */
int hires_graphics = 0;  /* 0 = lo res, 1 = hi res */
int text_mode = 0; /* 0 = graphics, 1 = text */
int mixed_mode = 0; /* 0 = full screen, 1 = text window */
int alt_page_select = 0; /* 0 = page 1, 1 = page 2 */

int tv_line = 0;
int tv_cycle = 0;

uint16_t hgr_page1[] = {
	0x2000, 0x2400, 0x2800, 0x2c00, 0x3000, 0x3400, 0x3800, 0x3c00,
	0x2080, 0x2480, 0x2880, 0x2c80, 0x3080, 0x3480, 0x3880, 0x3c80,
	0x2100, 0x2500, 0x2900, 0x2d00, 0x3100, 0x3500, 0x3900, 0x3d00,
	0x2180, 0x2580, 0x2980, 0x2d80, 0x3180, 0x3580, 0x3980, 0x3d80,
	0x2200, 0x2600, 0x2a00, 0x2e00, 0x3200, 0x3600, 0x3a00, 0x3e00,
	0x2280, 0x2680, 0x2a80, 0x2e80, 0x3280, 0x3680, 0x3a80, 0x3e80,
	0x2300, 0x2700, 0x2b00, 0x2f00, 0x3300, 0x3700, 0x3b00, 0x3f00,
	0x2380, 0x2780, 0x2b80, 0x2f80, 0x3380, 0x3780, 0x3b80, 0x3f80,
	0x2028, 0x2428, 0x2828, 0x2c28, 0x3028, 0x3428, 0x3828, 0x3c28,
	0x20a8, 0x24a8, 0x28a8, 0x2ca8, 0x30a8, 0x34a8, 0x38a8, 0x3ca8,
	0x2128, 0x2528, 0x2928, 0x2d28, 0x3128, 0x3528, 0x3928, 0x3d28,
	0x21a8, 0x25a8, 0x29a8, 0x2da8, 0x31a8, 0x35a8, 0x39a8, 0x3da8,
	0x2228, 0x2628, 0x2a28, 0x2e28, 0x3228, 0x3628, 0x3a28, 0x3e28,
	0x22a8, 0x26a8, 0x2aa8, 0x2ea8, 0x32a8, 0x36a8, 0x3aa8, 0x3ea8,
	0x2328, 0x2728, 0x2b28, 0x2f28, 0x3328, 0x3728, 0x3b28, 0x3f28,
	0x23a8, 0x27a8, 0x2ba8, 0x2fa8, 0x33a8, 0x37a8, 0x3ba8, 0x3fa8,
	0x2050, 0x2450, 0x2850, 0x2c50, 0x3050, 0x3450, 0x3850, 0x3c50,
	0x20d0, 0x24d0, 0x28d0, 0x2cd0, 0x30d0, 0x34d0, 0x38d0, 0x3cd0,
	0x2150, 0x2550, 0x2950, 0x2d50, 0x3150, 0x3550, 0x3950, 0x3d50,
	0x21d0, 0x25d0, 0x29d0, 0x2dd0, 0x31d0, 0x35d0, 0x39d0, 0x3dd0,
	0x2250, 0x2650, 0x2a50, 0x2e50, 0x3250, 0x3650, 0x3a50, 0x3e50,
	0x22d0, 0x26d0, 0x2ad0, 0x2ed0, 0x32d0, 0x36d0, 0x3ad0, 0x3ed0,
	0x2350, 0x2750, 0x2b50, 0x2f50, 0x3350, 0x3750, 0x3b50, 0x3f50,
	0x23d0, 0x27d0, 0x2bd0, 0x2fd0, 0x33d0, 0x37d0, 0x3bd0, 0x3fd0,
};

uint16_t hgr_page2[] = {
	0x4000, 0x4400, 0x4800, 0x4c00, 0x5000, 0x5400, 0x5800, 0x5c00,
	0x4080, 0x4480, 0x4880, 0x4c80, 0x5080, 0x5480, 0x5880, 0x5c80,
	0x4100, 0x4500, 0x4900, 0x4d00, 0x5100, 0x5500, 0x5900, 0x5d00,
	0x4180, 0x4580, 0x4980, 0x4d80, 0x5180, 0x5580, 0x5980, 0x5d80,
	0x4200, 0x4600, 0x4a00, 0x4e00, 0x5200, 0x5600, 0x5a00, 0x5e00,
	0x4280, 0x4680, 0x4a80, 0x4e80, 0x5280, 0x5680, 0x5a80, 0x5e80,
	0x4300, 0x4700, 0x4b00, 0x4f00, 0x5300, 0x5700, 0x5b00, 0x5f00,
	0x4380, 0x4780, 0x4b80, 0x4f80, 0x5380, 0x5780, 0x5b80, 0x5f80,
	0x4028, 0x4428, 0x4828, 0x4c28, 0x5028, 0x5428, 0x5828, 0x5c28,
	0x40a8, 0x44a8, 0x48a8, 0x4ca8, 0x50a8, 0x54a8, 0x58a8, 0x5ca8,
	0x4128, 0x4528, 0x4928, 0x4d28, 0x5128, 0x5528, 0x5928, 0x5d28,
	0x41a8, 0x45a8, 0x49a8, 0x4da8, 0x51a8, 0x55a8, 0x59a8, 0x5da8,
	0x4228, 0x4628, 0x4a28, 0x4e28, 0x5228, 0x5628, 0x5a28, 0x5e28,
	0x42a8, 0x46a8, 0x4aa8, 0x4ea8, 0x52a8, 0x56a8, 0x5aa8, 0x5ea8,
	0x4328, 0x4728, 0x4b28, 0x4f28, 0x5328, 0x5728, 0x5b28, 0x5f28,
	0x43a8, 0x47a8, 0x4ba8, 0x4fa8, 0x53a8, 0x57a8, 0x5ba8, 0x5fa8,
	0x4050, 0x4450, 0x4850, 0x4c50, 0x5050, 0x5450, 0x5850, 0x5c50,
	0x40d0, 0x44d0, 0x48d0, 0x4cd0, 0x50d0, 0x54d0, 0x58d0, 0x5cd0,
	0x4150, 0x4550, 0x4950, 0x4d50, 0x5150, 0x5550, 0x5950, 0x5d50,
	0x41d0, 0x45d0, 0x49d0, 0x4dd0, 0x51d0, 0x55d0, 0x59d0, 0x5dd0,
	0x4250, 0x4650, 0x4a50, 0x4e50, 0x5250, 0x5650, 0x5a50, 0x5e50,
	0x42d0, 0x46d0, 0x4ad0, 0x4ed0, 0x52d0, 0x56d0, 0x5ad0, 0x5ed0,
	0x4350, 0x4750, 0x4b50, 0x4f50, 0x5350, 0x5750, 0x5b50, 0x5f50,
	0x43d0, 0x47d0, 0x4bd0, 0x4fd0, 0x53d0, 0x57d0, 0x5bd0, 0x5fd0,
};

void liba2_init_graphics() {
	hires_graphics = 1;
	text_mode = 0;
	mixed_mode = 0;
	alt_page_select = 0;

	tv_line = 0;
	tv_cycle = 0;
}

void liba2_get_current_state(a2_output_t *buf) {
	buf->hires_graphics = hires_graphics;
	buf->text_mode = text_mode;
	buf->mixed_mode = mixed_mode;
	buf->alt_page_select = alt_page_select;
	buf->tv_line = tv_line;
	buf->tv_cycle = tv_cycle;
}

void liba2_restore_state(a2_output_t *buf) {
	hires_graphics = buf->hires_graphics;
	text_mode = buf->text_mode;
	mixed_mode = buf->mixed_mode;
	alt_page_select = buf->alt_page_select;
	tv_line = buf->tv_line;
	tv_cycle = buf->tv_cycle;
}

void liba2_read_softswitch(uint16_t addr) {
	switch (addr) {
		case 0xc050: text_mode = 0; break;
		case 0xc051: text_mode = 1; break;
		case 0xc052: mixed_mode = 0; break;
		case 0xc053: mixed_mode = 1; break;
		case 0xc054: alt_page_select = 0; break;
		case 0xc055: alt_page_select = 1; break;
		case 0xc056: hires_graphics = 0; break;
		case 0xc057: hires_graphics = 1; break;
	}
}

void liba2_write_softswitch(uint16_t addr) {
	switch (addr) {
		case 0xc050: text_mode = 0; break;
		case 0xc051: text_mode = 1; break;
		case 0xc052: mixed_mode = 0; break;
		case 0xc053: mixed_mode = 1; break;
		case 0xc054: alt_page_select = 0; break;
		case 0xc055: alt_page_select = 1; break;
		case 0xc056: hires_graphics = 0; break;
		case 0xc057: hires_graphics = 1; break;
	}
}

int liba2_get_scan_line_type(int line) {
	int scan_line_type;

	if (text_mode) {
		scan_line_type = SCAN_LINE_TEXT;
	}
	else {
		if (mixed_mode && line >= 160) scan_line_type = SCAN_LINE_TEXT;
		else if (hires_graphics) scan_line_type = SCAN_LINE_HIRES;
		else scan_line_type = SCAN_LINE_LORES;
	}
	return scan_line_type;
}

void liba2_copy_video(a2_output_t *output, uint8_t inst_cycles) {
	int line = tv_line - FIRST_OUTPUT_SCAN_LINE;
	int cycle = tv_cycle - FIRST_OUTPUT_CYCLE;
	uint16_t line_source;
	uint8_t *hires_memory = output->video;
	uint8_t scan_line_type;

	if (line >= 0 && line < 192 && cycle > -8 && cycle < 40) {
		hires_memory += (40 * line) + cycle;
		if (alt_page_select) line_source = hgr_page2[line];
		else line_source = hgr_page1[line];
		line_source += cycle;
		output->scan_line_type[line] = liba2_get_scan_line_type(line);
		while (cycle < 40 && inst_cycles > 0) {
			if (cycle >= 0) *hires_memory = memory[line_source];
			hires_memory++;
			line_source++;
			cycle++;
			inst_cycles--;
		}
	}
}
