{% extends 'bee_django_social_feed/base.html' %}

{% block content %}
    <div class="col-md-12" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-on="http://www.w3.org/1999/xhtml">

        <div><h3>日志 | <a href="{% url 'bee_django_social_feed:albums' %}">美好的生活</a></h3></div>

        {% if user and user.is_pause %}

        {% else %}
            <div id="new-feed">
                {% verbatim %}
                <div class="bg-success text-center" v-html="success_message">
                </div>
                <div class="bg-danger" v-html="error_message">
                </div>
                {% endverbatim %}
                <textarea class="form-control OwO-textarea" rows="3" placeholder="分享你的感受" v-model="content">
                </textarea>

                <div class="OwO"></div>
                <div>
                    <input type="file" @change="on_upload_image_change" style="display:none;"
                           accept="image/*" ref="image_input" multiple/>
                    <button class="btn btn-default" @click="$refs.image_input.click()">图片</button>

                    <input type="submit" value="发布" class="btn btn-default"
                           @click.prevent="post_new_feed($event)"
                           data-confirm="{% url 'bee_django_social_feed:create_feed' %}"/>
                </div>

                <div id="image_list"
                     v-if="selected_files"
                     style="width:250px; padding:10px; border:1px solid #ccc;">
                    <h5>上传图片列表:</h5>
                    <image-list v-for="file in selected_files" v-bind:key="file.name" v-bind:name="file.name">
                    </image-list>
                </div>
            </div>
        {% endif %}

        <br/>

        <div id="feeds">
            <div>
                日志显示：<a href="#" v-on:click="load_all_page">所有</a> |
                <a href="#" v-on:click.prevent="load_feedstar_page"><b>精华</b></a> |
                <a href="#" v-on:click.prevent="load_classmates_page(request_user_id)">同班</a> |
                <a href="#" v-on:click.prevent="load_my_page(request_user_id)">我</a>
            </div>
            <br/>

            <div>
                <input type="text" placeholder="关键字..." v-model="search_keywords"/>
                <input type="button" value="搜索" v-on:click.prevent="search_with_keywords()"/>
            </div>
            <feed v-for="feed in feeds" v-bind:key="feed.pk"
                  v-bind:id="feed.id" v-bind:publisher_data="feed.publisher_data" v-bind:content="feed.content"
                  v-bind:publisher_avatar="feed.publisher_avatar"
                  v-bind:publisher_icon_list="feed.publisher_icon_list"
                  v-bind:emojis.sync="feed.emojis" v-bind:comments.sync="feed.comments"
                  v-bind:created_at="feed.created_at" v-bind:link_name.sync="feed.link_name"
                  v-bind:link_link="feed.link_link" v-bind:images="feed.images"
                  v-bind:is_stick.sync="feed.is_stick" v-bind:stick_expired_at="feed.stick_expired_at"
                  v-bind:is_star.sync="feed.is_star" v-bind:star_at="feed.star_at"
                  v-bind:input_show.sync="feed.input_show">

            </feed>
        </div>

        <div id="feeds-loader">
            <div v-if="status == 1">页面加载中，请稍后...</div>
            <div v-else-if="status == 2" v-on:click="load_more_page">
                加载超时，点击重试
            </div>
            <div v-else-if="status == 3">
                下面没有了
            </div>
            <div v-else>

            </div>
        </div>

    </div>
{% endblock content %}

{% block scripts %}
    {% load static %}
    <script src="{% static 'bee_django_social_feed/app.js' %}"></script>
    <script src="{% static 'bee_django_social_feed/axios.min.js' %}"></script>

    <script type="text/x-template" id="image-list">
        {% verbatim %}
        <div>
            {{ name }}
        </div>
        {% endverbatim %}
    </script>

    <script type="text/x-template" id="feed-template">
        <div class="feed" v-bind:class="{feedstick:is_stick, feedstar:is_star}">
            {% verbatim %}
            <div class="feed-author">
                <img v-if="publisher_avatar" v-bind:src="publisher_avatar" class="avatar"/>
                <a href="#" v-on:click="load_user_page(publisher_data.id, $event)">
                    {{ publisher_data.first_name || publisher_data.username }}
                </a>
            </div>

            <div class="feed-link" v-if="has_link_name">
                对
                <span>{{ link_name }}</span>
                发表了评论:
            </div>

            <div class="feed-content">
                <span v-if="is_stick">
                    <span style="color:white;background-color:red;padding:2px;border-radius:5px;">置顶</span>
                    &nbsp;
                </span>
                <span v-if="is_star">
                    <span style="color:white;background-color:blueviolet;padding:2px;border-radius:5px;">精华</span>
                    &nbsp;
                </span>
                <span v-if="content.length <= 140">{{ content }}</span>
                <span v-else>
                    <span v-if="is_truncate">
                        {{ content | truncate }}
                        <br/>
                        <a href="#" v-on:click.prevent="fold_content()">全文</a>
                    </span>
                    <span v-else>
                        {{ content }}
                        <br/>
                        <a href="#" v-on:click.prevent="unfold_content()">收起</a>
                    </span>
                </span>
            </div>

            <div v-if="image_showbox_url === null">
                <div class="feed-images" style="height:90px;" v-if="images_count > 0 && images_count <= 3">
                    <div class="feed-image" v-for="image in images" style="float:left;">
                        <a href="#" v-on:click.prevent="show_image(image)">
                            <img v-bind:src="image.thumbnail_url" class="img-thumbnail img-responsive"/>
                        </a>

                    </div>
                </div>
                <div class="feed-images" style="height:170px;width:300px;"
                     v-else-if="images_count > 3 && images_count <= 6">
                    <div class="feed-image" v-for="image in images" style="float:left;">
                        <a href="#" v-on:click.prevent="show_image(image)">
                            <img v-bind:src="image.thumbnail_url" class="img-thumbnail img-responsive"/>
                        </a>

                    </div>
                </div>
                <div class="feed-images" style="height:250px;width:300px;" v-else-if="images_count > 6">
                    <div class="feed-image" v-for="image in images" style="float:left;">
                        <a href="#" v-on:click.prevent="show_image(image)">
                            <img v-bind:src="image.thumbnail_url" class="img-thumbnail img-responsive"/>
                        </a>

                    </div>
                </div>
            </div>

            <div class="feed-image-showbox" v-if="image_showbox_url">
                <a href="#" v-on:click.prevent="fold_image()">
                    <img v-bind:src="image_showbox_url" class="img-responsive"/>
                </a>
            </div>

            <div class="feed-time">
                <a href="#" v-on:click.prevent="load_feed_data(id)">{{ created_at | formatDate }}</a>
                <span v-if="is_stick && stick_expired_at">
                    , 将于 {{ stick_expired_at | formatDate }} 取消置顶
                </span>
            </div>

            <div class="feed-emoji" v-if="has_emojis">
                <i class="glyphicon glyphicon-heart-empty"></i>
                <a href="#" v-for="emoji in emojis" class="feed-emoji-users"
                   v-on:click="load_user_page(emoji.user_data.id, $event)">
                    {{ emoji.user_data.first_name || emoji.user_data.username }}
                </a>
            </div>
            <div class="feed-comments" v-if="has_comments">
                <div v-for="comment in comments" v-on:click="on_click_comment(comment)">
                    <a href="#" v-on:click="load_user_page(comment.user_data.id, $event)">
                        {{ comment.user_data.first_name || comment.user_data.username }} : </a>
                    <span v-if="comment.to_user_data != null">
                        回复 {{ comment.to_user_data.first_name || comment.to_user_data.username }}
                    </span>
                    {{ comment.comment }}
                </div>
            </div>

            <div class="feed-button">
                <span v-if="can_star_feed(publisher_data)">
                <unstar v-if="is_star" v-on:click.native.prevent="unstar_feed(id)"></unstar>
                <star v-else v-on:click.native.prevent="star_feed(id)"></star>
                </span>
                <span v-if="can_stick_feed(publisher_data)">
                    <unstick v-if="is_stick" v-on:click.native.prevent="unstick_feed(id)"></unstick>
                    <stick v-else v-on:click.native.prevent="stick_feed(id)"></stick>
                </span>
                <emoji-did v-if="is_request_user_emoji"></emoji-did>
                <emoji-button v-else v-on:click.native.prevent="post_emoji(id)"></emoji-button>
                <comment-button v-on:click.native.prevent="show_comment_input()"></comment-button>
                <span v-if="can_delete_feed(publisher_data)">
                    <a href="#" v-on:click="delete_feed(id)">
                        <i class="glyphicon glyphicon-remove">删除</i>
                    </a>
                </span>
            </div>

            <div class="feed-comment-input" v-if="input_show">
                <textarea v-if="comment_to_user_exists()" class="form-control OwO-textarea" rows="3"
                          v-model="new_comment" v-bind:placeholder="comment_to_user_name()">
                </textarea>
                <textarea v-else placeholder="评论" class="form-control OwO-textarea" rows="3"
                          v-model="new_comment">
                </textarea>

                <div class="OwO"></div>
                <button class="btn btn-default" v-on:click.prevent="post_comment(id, new_comment)">提交</button>
            </div>
            {% endverbatim %}
        </div>
    </script>

    <script type="text/x-template" id="star">
        <a href="#"><i class="glyphicon glyphicon-star-empty">加精</i></a>
    </script>

    <script type="text/x-template" id="unstar">
        <a href="#"><i class="glyphicon glyphicon-star">取消加精</i></a>
    </script>

    <script type="text/x-template" id="stick">
        <a href="#"><i class="glyphicon glyphicon-pushpin">置顶</i></a>
    </script>

    <script type="text/x-template" id="unstick">
        <a href="#"><i class="glyphicon glyphicon-pushpin">取消置顶</i></a>
    </script>

    <script type="text/x-template" id="emoji-button">
        <a href="#"><i class="glyphicon glyphicon-heart-empty">赞</i></a>
    </script>

    <script type="text/x-template" id="emoji-did">
        <span><i class="glyphicon glyphicon-heart-empty">已赞</i></span>
    </script>

    <script type="text/x-template" id="comment-button">
        <a href="#"><i class="glyphicon glyphicon-pencil">评论</i></a>
    </script>

    <script src="{% static 'bee_django_social_feed/OwO.min.js' %}"></script>

{% endblock scripts %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'bee_django_social_feed/OwO.min.css' %}">
    <link rel="stylesheet" href="{% static 'bee_django_social_feed/app.css' %}">
    <style type="text/css">
        .feed-image {
            height: 80px;
            width: 80px;
        }

        .avatar {
            border-radius: 50%;
            width: 25px;
            height: 25px;
        }
    </style>
{% endblock styles %}